var ENTER_KEY=13;var ESC_KEY=27;var LEFT_ARROW_KEY=37;var TOP_ARROW_KEY=38;var RIGHT_ARROW_KEY=39;var DOWN_ARROW_KEY=40;var DELETE_KEY=46;var B_KEY=66;var C_KEY=67;var D_KEY=68;var F_KEY=70;var V_KEY=86;var Z_KEY=90;var F1_KEY=112;var F2_KEY=113;var app={omtg:{},msgs:{DELETE_CONNECTION:"This connection will be detached. Are you sure?",DELETE_DIAGRAM:"This diagram will be removed. All its connection will be detached. Are you sure?",DELETE_DIAGRAMS:"The selected diagrams will be removed. All their connections will be detached. Are you sure?",EMPTY_PROJECT:"Project is empty, there is nothing to export!",NOT_EMPTY_PROJECT:"Project is not empty"}};$(function(){app.classTools=new app.Tools([{name:"polygon",model:"omtgDiagram",tooltip:"Polygon",icon:"imgs/omtg/polygon.png"},{name:"line",model:"omtgDiagram",tooltip:"Line",icon:"imgs/omtg/line.png"},{name:"point",model:"omtgDiagram",tooltip:"Point",icon:"imgs/omtg/point.png"},{name:"node",model:"omtgDiagram",tooltip:"Node",icon:"imgs/omtg/node.png"},{name:"isolines",model:"omtgDiagram",tooltip:"Isolines",icon:"imgs/omtg/isolines.png"},{name:"planar-subdivision",model:"omtgDiagram",tooltip:"Planar Subdivision",icon:"imgs/omtg/planar-subdivision.png"},{name:"TIN",model:"omtgDiagram",tooltip:"Triangular Irregular Network",icon:"imgs/omtg/TIN.png"},{name:"tesselation",model:"omtgDiagram",tooltip:"Tesselation",icon:"imgs/omtg/tesselation.png"},{name:"sample",model:"omtgDiagram",tooltip:"Sample",icon:"imgs/omtg/sample.png"},{name:"un-line",model:"omtgDiagram",tooltip:"Unidirectional Line",icon:"imgs/omtg/un-line.png"},{name:"bi-line",model:"omtgDiagram",tooltip:"Bidirectional Line",icon:"imgs/omtg/bi-line.png"},{name:"conventional",model:"omtgDiagram",tooltip:"Conventional",icon:"imgs/omtg/conventional.png"}]);app.relationshipTools=new app.Tools([{name:"association",model:"omtgRelation",tooltip:"Association",icon:"imgs/relation/association.png"},{name:"spatial-association",model:"omtgRelation",tooltip:"Spatial Association",icon:"imgs/relation/spatial-association.png"},{name:"aggregation",model:"omtgRelation",tooltip:"Aggregation",icon:"imgs/relation/aggregation.png"},{name:"spatial-aggregation",model:"omtgRelation",tooltip:"Spatial Aggregation",icon:"imgs/relation/spatial-aggregation.png"},{name:"cartographic-generalization-overlapping",model:"omtgRelation",tooltip:"Cartographic Generalization Overlapping",icon:"imgs/relation/cartographic-generalization-overlapping.png"},{name:"cartographic-generalization-disjoint",model:"omtgRelation",tooltip:"Cartographic Generalization Disjoint",icon:"imgs/relation/cartographic-generalization-disjoint.png"},{name:"generalization-disjoint-partial",model:"omtgRelation",tooltip:"Generalization Disjoint-Partial",icon:"imgs/relation/generalization-disjoint-partial.png"},{name:"generalization-overlapping-partial",model:"omtgRelation",tooltip:"Generalization Overlapping-Partial",icon:"imgs/relation/generalization-overlapping-partial.png"},{name:"generalization-disjoint-total",model:"omtgRelation",tooltip:"Generalization Disjoint-Total",icon:"imgs/relation/generalization-disjoint-total.png"},{name:"generalization-overlapping-total",model:"omtgRelation",tooltip:"Generalization Overlapping-Total",icon:"imgs/relation/generalization-overlapping-total.png"},{name:"arc-network",model:"omtgRelation",tooltip:"Arc-Node Network",icon:"imgs/relation/arc-network.png"}]);app.toolboxes=new app.Toolboxes([{name:"Classes",tools:app.classTools},{name:"Relationships",tools:app.relationshipTools}]);app.canvas=new app.Canvas();app.bodyView=new app.BodyView();app.navbarView=new app.NavbarView({el:$("#navbar")});app.toolboxesView=new app.ToolboxesView({el:$("#section-sidebar"),model:app.toolboxes});app.canvasView=new app.CanvasView({el:"#canvas",model:app.canvas})});(function(){app.omtg.Attribute=Backbone.Model.extend({defaults:function(){return{name:"",type:"INTEGER",defaultValue:"",isKey:false,length:"",scale:"",size:"",isNotNull:false,domain:""}},toXML:function(){var b="<attribute>";b+="<name>"+this.get("name")+"</name>";b+="<type>"+this.get("type")+"</type>";if(this.get("isKey")){b+="<key>"+this.get("isKey")+"</key>"}if(this.get("length")!=""){b+="<length>"+this.get("length")+"</length>"}if(this.get("scale")!=""){b+="<scale>"+this.get("scale")+"</scale>"}if(this.get("isNotNull")){b+="<not-null>"+this.get("isNotNull")+"</not-null>"}if(this.get("defaultValue")!=""){b+="<default>"+this.get("defaultValue")+"</default>"}if(this.get("size")!=""){b+="<size>"+this.get("size")+"</size>"}if(this.get("domain")!=""){b+="<domain>";var a=this.domain.split("\n");for(var c=0;c<a.length;c++){b+="<value>"+a[c]+"</value>"}b+="</domain>"}b+="</attribute>";return b}})})();(function(){app.omtg.Diagram=Backbone.Model.extend({defaults:function(){return{id:this.cid,type:"",name:"Class_"+this.cid,attributes:new app.omtg.Attributes(),selected:false,top:10,left:10}},duplicate:function(){var c=Math.floor(Math.random()*31);var a=new app.omtg.Diagram({type:this.get("type"),left:this.get("left")+40+c,top:this.get("top")+40+c,attributes:this.get("attributes").clone()});for(var b=1;;b++){var d=this.get("name")+"_"+b;if(app.canvas.get("diagrams").findByName(d)==null){a.set("name",d);break}}return a},copy:function(){app.canvas.set("clipboard",this.clone())},move:function(b,a){this.set("top",this.get("top")+b);this.set("left",this.get("left")+a)},toggleSelected:function(){this.set("selected",!this.get("selected"))},toXML:function(){return"<class><name>"+this.get("name")+"</name><top>"+this.get("top")+"</top><left>"+this.get("left")+"</left><type>"+this.get("type")+"</type><attributes>"+this.get("attributes").toXML()+"</attributes></class>"}})})();(function(){app.Tool=Backbone.Model.extend({defaults:function(){return{name:"",type:"",tooltip:"",icon:"",active:false}},toggleActive:function(){this.set("active",!this.get("active"))}})})();(function(){app.Toolbox=Backbone.Model.extend({defaults:function(){return{name:"",tools:null}}})})();(function(){app.Canvas=Backbone.Model.extend({defaults:function(){return{diagrams:new app.omtg.Diagrams(),activeTool:null,grid:true,diagramShadow:true,snapToGrid:10,clipboard:null,undoManager:new app.UndoManager()}},toXML:function(){var a='<?xml version="1.0" encoding="UTF-8"?><omtg-conceptual-schema xsi:noNamespaceSchemaLocation="omtg-schema-template.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">'+this.get("diagrams").toXML()+this.connectionsToXML()+"</omtg-conceptual-schema>";return a},hasClipboard:function(){if(this.get("clipboard")!=null){return true}return false},duplicateDiagram:function(a){var b=a.duplicate();this.get("diagrams").add(b);this.trigger("updateHistory",this)},copyDiagram:function(a){a.copy()},pasteDiagram:function(d,c){var b=this.get("clipboard");if(b!=null){var a=b.duplicate();a.set("top",d);a.set("left",c);this.get("diagrams").add(a)}this.trigger("updateHistory",this)},connectionsToXML:function(){var a=app.plumb.getConnections();var d="";for(var b=0;b<a.length;b++){var c=a[b].getType()[0];if(c!="arc-network-sibling"&&c!="cartographic-leg"&&c!="generalization-leg"){d+=this.connectionToXML(a[b])}}return"<relationships>"+d+"</relationships>"},connectionToXML:function(f){var c=f.getType()[0];switch(c){case"aggregation":var b=this.get("diagrams").getAttrById(f.sourceId,"name");var n=this.get("diagrams").getAttrById(f.targetId,"name");return"<conventional-aggregation><class1>"+b+"</class1><class2>"+n+"</class2></conventional-aggregation>";case"spatial-aggregation":var b=this.get("diagrams").getAttrById(f.sourceId,"name");var n=this.get("diagrams").getAttrById(f.targetId,"name");return"<spatial-aggregation><class1>"+b+"</class1><class2>"+n+"</class2></spatial-aggregation>";case"association":var q=f.getOverlay("description-label").getLabel();var b=this.get("diagrams").getAttrById(f.sourceId,"name");var n=this.get("diagrams").getAttrById(f.targetId,"name");var l=f.getParameter("minA");var k=f.getParameter("maxA");var j=f.getParameter("minB");var h=f.getParameter("maxB");return"<conventional><name>"+q+"</name><class1>"+b+"</class1><cardinality1><min>"+l+"</min><max>"+k+"</max></cardinality1><class2>"+n+"</class2><cardinality2><min>"+j+"</min><max>"+h+"</max></cardinality2></conventional>";case"spatial-association":var q=f.getOverlay("description-label").getLabel().split(" ")[0];var b=this.get("diagrams").getAttrById(f.sourceId,"name");var n=this.get("diagrams").getAttrById(f.targetId,"name");var l=f.getParameter("minA");var k=f.getParameter("maxA");var j=f.getParameter("minB");var h=f.getParameter("maxB");var d=f.getParameter("distance");return"<topological><spatial-relations><spatial-relation>"+q+"</spatial-relation><distance>"+d+"</distance></spatial-relations><class1>"+b+"</class1><cardinality1><min>"+l+"</min><max>"+k+"</max></cardinality1><class2>"+n+"</class2><cardinality2><min>"+j+"</min><max>"+h+"</max></cardinality2></topological>";case"arc-network":case"arc-network-self":var q=f.getOverlay("description-label").getLabel();var b=this.get("diagrams").getAttrById(f.sourceId,"name");var n=this.get("diagrams").getAttrById(f.targetId,"name");return"<network><name>"+q+"</name><class1>"+b+"</class1><class2>"+n+"</class2></network>";case"generalization-disjoint-partial":case"generalization-disjoint-total":case"generalization-overlapping-partial":case"generalization-overlapping-total":var m=this.get("diagrams").getAttrById(f.sourceId,"name");var g=f.endpoints[0];var s=g.getParameter("participation");var o=g.getParameter("disjointness");var e="";var a=g.getAttachedElements();for(var r=0;r<a.length;r++){var p=this.get("diagrams").getAttrById(a[r].targetId,"name");e+="<subclass>"+p+"</subclass>"}return"<generalization><superclass>"+m+"</superclass><participation>"+s+"</participation><disjointness>"+o+"</disjointness><subclasses>"+e+"</subclasses></generalization>";case"cartographic-generalization-disjoint":case"cartographic-generalization-overlapping":var m=this.get("diagrams").getAttrById(f.sourceId,"name");var o=f.getParameter("disjointness");var q=f.getOverlay("cartographic-label").getLabel();var e="<subclass>"+this.get("diagrams").getAttrById(f.targetId,"name")+"</subclass>";var a=app.plumb.getConnections({source:f.getOverlay("cartographic-square").getElement()});for(var r=0;r<a.length;r++){var p=this.get("diagrams").getAttrById(a[r].targetId,"name");e+="<subclass>"+p+"</subclass>"}return"<conceptual-generalization><superclass>"+m+"</superclass><scale-shape>"+q+"</scale-shape><disjointness>"+o+"</disjointness><subclasses>"+e+"</subclasses></conceptual-generalization>";default:return""}}})})();(function(){app.UndoManager=Backbone.Model.extend({defaults:function(){return{historyIndex:-1,history:[]}},update:function(){var b=app.canvas.toXML();var c=_.clone(this.get("history"));var a=this.get("historyIndex");if(!c||c[a]!=b){c=c.slice(0,a+1);c.push(b);this.set("history",c);this.set("historyIndex",++a)}},redo:function(){var a=this.get("historyIndex");if(a<this.get("history").length){this.set("historyIndex",++a);return this.get("history")[a]}return""},undo:function(){var a=this.get("historyIndex");if(a>=0){this.set("historyIndex",--a);return this.get("history")[a]}return""},hasRedo:function(){var a=this.get("historyIndex");if(a!==this.get("history").length-1){return true}return false},hasUndo:function(){var a=this.get("historyIndex");if(a>=0){return true}return false}})})();(function(){app.omtg.Attributes=Backbone.Collection.extend({model:app.omtg.Attribute,toXML:function(){var a="";this.each(function(b){a+=b.toXML()});return a}})})();(function(){app.omtg.Diagrams=Backbone.Collection.extend({model:app.omtg.Diagram,initialize:function(){this.listenTo(this,"change:selected",this.propagate_selected)},removeAll:function(){var a;while(a=this.last()){a.trigger("destroy",a)}},removeSet:function(b){if(confirm(app.msgs.DELETE_DIAGRAMS)){for(var a=0;a<b.length;a++){app.plumb.detachAllConnections(b[a].id,{fireEvent:false});b[a].trigger("destroy",b[a])}app.canvasView.updateHistory()}},getSelected:function(){return this.where({selected:true})},propagate_selected:function(a){if(!a.get("selected")){return}this.each(function(b){if(a.id!=b.id){b.set({selected:false},{silent:false})}})},unselectAll:function(){this.each(function(a){a.set({selected:false},{silent:false})})},getAttrById:function(c,a){var b=this.findWhere({id:c});if(b){return b.get(a)}return null},findByName:function(a){var c=this.where({name:a});for(var b=0;b<c.length;b++){return c[b]}return null},toXML:function(){var a="";this.each(function(b){a+=b.toXML()});return"<classes>"+a+"</classes>"}})})();(function(){app.Tools=Backbone.Collection.extend({model:app.Tool,initialize:function(){this.listenTo(this,"change:active",this.propagate_active)},propagate_active:function(a){if(!a.get("active")){return}this.each(function(b){if(a.get("name")!=b.get("name")){b.set({active:false},{silent:false})}});app.canvas.set("activeTool",a)},deactivateAll:function(){this.each(function(a){a.set({active:false},{silent:false})})},activated:function(){return this.findWhere({active:true})},getTooltip:function(a){return this.findWhere({name:a}).get("tooltip")}})})();(function(){app.Toolboxes=Backbone.Collection.extend({model:app.Toolbox})})();(function(a){app.BodyView=Backbone.View.extend({el:"body",events:{keydown:"keyHandler"},keyHandler:function(d){if(a(".modal-dialog").length>0){return}var c=d.keyCode||d.which;switch(c){case LEFT_ARROW_KEY:if(d.shiftKey){_.invoke(app.canvas.get("diagrams").getSelected(),"move",0,-1)}else{_.invoke(app.canvas.get("diagrams").getSelected(),"move",0,-4)}break;case TOP_ARROW_KEY:if(d.shiftKey){_.invoke(app.canvas.get("diagrams").getSelected(),"move",-1,0)}else{_.invoke(app.canvas.get("diagrams").getSelected(),"move",-4,0)}break;case RIGHT_ARROW_KEY:if(d.shiftKey){_.invoke(app.canvas.get("diagrams").getSelected(),"move",0,1)}else{_.invoke(app.canvas.get("diagrams").getSelected(),"move",0,4)}break;case DOWN_ARROW_KEY:if(d.shiftKey){_.invoke(app.canvas.get("diagrams").getSelected(),"move",1,0)}else{_.invoke(app.canvas.get("diagrams").getSelected(),"move",4,0)}break;case DELETE_KEY:var b=app.canvas.get("diagrams").getSelected();if(b.length>=1){app.canvas.get("diagrams").removeSet(b)}break;case C_KEY:if(d.ctrlKey){d.preventDefault();var b=app.canvas.get("diagrams").getSelected();if(b.length==1){app.canvas.copyDiagram(b[0])}}break;case D_KEY:if(d.ctrlKey){d.preventDefault();var b=app.canvas.get("diagrams").getSelected();if(b.length==1){app.canvas.duplicateDiagram(b[0])}}break;case B_KEY:if(d.ctrlKey&&d.shiftKey){var b=app.canvas.get("diagrams").getSelected();if(b.length==1){b[0].trigger("sendtoback",b[0])}}break;case F_KEY:if(d.ctrlKey&&d.shiftKey){var b=app.canvas.get("diagrams").getSelected();if(b.length==1){b[0].trigger("bringtofront",b[0])}}break;case V_KEY:if(d.ctrlKey){var e=Math.floor(Math.random()*41);app.canvas.pasteDiagram(10+e,10+e)}break;case Z_KEY:if(d.ctrlKey){if(d.shiftKey){app.canvasView.redoHistory()}else{app.canvasView.undoHistory()}}break;case F1_KEY:d.preventDefault();new app.AboutView();break;case F2_KEY:var b=app.canvas.get("diagrams").getSelected();if(b.length==1){b[0].trigger("edit",b[0])}break}}})})(jQuery);(function(a){app.omtg.AttributeView=Backbone.View.extend({tagName:"tr",initialize:function(){this.template=_.template("<td><% if( isKey ){ %> <img class='attribute-key' src='imgs/omtg/key.png'> <% } %></td><td><%= attr %></td>")},render:function(){this.$el.html(this.template({isKey:this.model.get("isKey"),attr:this.model.get("type")=="VARCHAR"?this.model.escape("name")+": "+this.model.get("type")+"("+this.model.get("length")+")":this.model.escape("name")+": "+this.model.get("type")}));return this}})})(jQuery);(function(a){app.omtg.DiagramView=Backbone.View.extend({tagName:"div",className:"diagram-container",parentSelector:"#canvas",events:{"click .badge-delete":"deleteDiagram","click .badge-edit":"edit",click:"handleClick",dblclick:"handleDblClick",mouseenter:"handleMouseEnter",mouseleave:"handleMouseLeave",mouseup:"updatePosition",contextmenu:"openContextMenu"},initialize:function(){this.$conventional=a("#omtg-conventional-template");this.$georeferenced=a("#omtg-georeferenced-template");this.listenTo(this.model,"change",this.render);this.listenTo(this.model,"destroy",this.remove);this.listenTo(this.model,"edit",this.edit);this.listenTo(this.model,"bringtofront",this.bringToFront);this.listenTo(this.model,"sendtoback",this.sendToBack)},render:function(){if(this.model.get("type")=="conventional"){this.template=_.template(this.$conventional.html())}else{this.template=_.template(this.$georeferenced.html())}this.el.id=this.model.get("id");this.$el.css({top:this.model.get("top")+"px",left:this.model.get("left")+"px"});this.$el.html(this.template(this.model.toJSON()));var b=this.model.get("attributes");b.each(function(d){var c=new app.omtg.AttributeView({model:d});this.$(".d-body > table > tbody").append(c.render().el)},this);if(this.model.get("selected")){this.$el.addClass("selected");this.$(".badge-delete").removeClass("hidden");this.$(".badge-edit").removeClass("hidden")}else{this.$el.removeClass("selected")}if(app.canvas.get("diagramShadow")){this.$el.addClass("diagram-container-shadow")}app.plumbUtils.repaintAllAnchors();app.plumb.repaintEverything();return this},handleClick:_.debounce(function(b){if(this.doubleclicked){this.doubleclicked=false}else{this.model.toggleSelected()}},200),handleDblClick:function(b){this.doubleclicked=true;this.edit.call(this,b)},edit:function(c){if(c&&c.stopPropagation){c.stopPropagation()}var d=false;if(app.plumb.getConnections({source:this.el.id}).length||app.plumb.getConnections({target:this.el.id}).length){d=true}var b=new app.omtg.DiagramEditorView({model:this.model,hasConnections:d})},deleteDiagram:function(b){if(b){b.stopPropagation()}if(confirm(app.msgs.DELETE_DIAGRAM)){app.plumb.detachAllConnections(this.$el);this.model.trigger("destroy",this.model);app.canvasView.updateHistory()}},updatePosition:function(d){var c=app.canvas.get("snapToGrid");this.model.set({left:Math.round(this.$el.position().left/c)*c,top:Math.round(this.$el.position().top/c)*c});var e=app.plumb.getConnections(this.$el);for(var b=0;b<e.length;b++){app.plumbUtils.updateLabelsPosition(e[b])}},handleMouseEnter:function(){this.$el.addClass("hovered");this.$(".badge-delete").removeClass("hidden");this.$(".badge-edit").removeClass("hidden")},handleMouseLeave:function(){this.$el.removeClass("hovered");this.$(".badge-delete").addClass("hidden");this.$(".badge-edit").addClass("hidden")},bringToFront:function(){a(this.render().el).appendTo(this.parentSelector)},sendToBack:function(){a(this.render().el).prependTo(this.parentSelector)},openContextMenu:function(b){b.preventDefault();app.contextMenuView=new app.ContextMenuView({diagramView:this,left:b.pageX,top:b.pageY})}})})(jQuery);(function(a){app.omtg.DiagramEditorView=Backbone.View.extend({id:"diagram-editor",className:"modal fade",events:{"click #btnUpdate":"updateDiagram","hidden.bs.modal":"teardown","click #ulDiagramType a":"selectType","input #inputDiagramName":"inputNameChanged","click #btnAddRow":"newAttribute","click .btnRowDelete":"deleteAttribute","click .btnRowUp":"moveAttributeUp","click .btnRowDown":"moveAttributeDown","blur .name-editable":"editName","blur .value-editable":"editValue","blur .length-editable":"editLength","click .toggleKey":"toggleKey","click .toggleNotNull":"toggleNotNull","click .ulAttributeType a":"selectAttributeType",submit:"preventSubmission"},initialize:function(b){this.template=_.template(a("#omtg-diagram-editor-template").html());this.hasConnections=b.hasConnections;this.attrsClone=this.model.get("attributes").clone();this.render()},render:function(){this.$el.html(this.template(this.model.toJSON()));this.$el.modal({backdrop:"static",keyboard:false,show:true});if(this.hasConnections){this.$("#inputDiagramType").addClass("disabled");this.$("#inputDiagramTypeToggle").addClass("disabled")}this.attrsClone.each(function(b){this.addAttribute(b)},this);return this},teardown:function(){this.$el.data("modal",null);this.remove()},selectType:function(d){var c=this.$(d.currentTarget).html();this.$("#inputDiagramType").html(c);var b=this.$(d.currentTarget).data("type-name");this.$("#inputDiagramType").data("type-name",b)},inputNameChanged:function(d){var b=this.$(d.currentTarget).val().trim();var c=new RegExp("[a-zA-Z0-9][w#@]{0,63}$");if(c.test(b)&&/\s/.test(b)==false&&app.canvas.get("diagrams").findByName(b)==null){this.$("#formDiagramName").removeClass("has-error");this.$("#btnUpdate").removeClass("disabled")}else{this.$("#formDiagramName").addClass("has-error");this.$("#btnUpdate").addClass("disabled")}},updateDiagram:function(){var e=this.$("#inputDiagramType").data("type-name");if(e){this.model.set("type",e)}var c=this.$("#inputDiagramName").val().trim();if(c){this.model.set("name",c)}for(var d=0;d<this.attrsClone.length;d++){var b=this.attrsClone.at(d);if(b.get("name")==""){this.attrsClone.remove(b);d--}}this.model.set({attributes:this.attrsClone});this.model.trigger("change",this.model)},newAttribute:function(){var b=new app.omtg.Attribute();this.addAttribute(b);this.attrsClone.add(b)},addAttribute:function(c){var d=_.template(a("#omtg-attribute-row-editor-template").html());var b=d(c.toJSON());this.$("#attrTable > tbody > tr:last").before(b)},deleteAttribute:function(c){var b=this.$(c.currentTarget).closest("tr");this.attrsClone.remove(this.attrsClone.at(b.index()));b.remove()},moveAttributeUp:function(d){var b=this.$(d.currentTarget).closest("tr");if(b.index()>0){var c=this.attrsClone.at(b.index());this.attrsClone.remove(c);this.attrsClone.add(c,{at:b.index()-1});b.insertBefore(b.prev())}},moveAttributeDown:function(d){var b=this.$(d.currentTarget).closest("tr");if(b.index()<this.attrsClone.length-1){var c=this.attrsClone.at(b.index()+1);this.attrsClone.remove(c);this.attrsClone.add(c,{at:b.index()});b.insertAfter(b.next())}},editName:function(d){var b=this.$(d.currentTarget).closest("tr").index();var c=this.$(d.currentTarget).text();c=c.replace(/\s+/g,"_");this.attrsClone.at(b).set("name",c)},editValue:function(c){var b=this.$(c.currentTarget).closest("tr").index();this.attrsClone.at(b).set("defaultValue",this.$(c.currentTarget).text())},editLength:function(d){var b=this.$(d.currentTarget).closest("tr").index();var c=this.$(d.currentTarget).text();this.attrsClone.at(b).set("length",c>=1?c:"50")},toggleKey:function(c){var b=this.$(c.currentTarget).closest("tr").index();this.attrsClone.at(b).set("isKey",this.$(c.currentTarget).prop("checked"))},toggleNotNull:function(c){var b=this.$(c.currentTarget).closest("tr").index();this.attrsClone.at(b).set("isNotNull",this.$(c.currentTarget).prop("checked"))},selectAttributeType:function(d){var b=this.$(d.currentTarget).closest("tr").index();var c=this.$(d.currentTarget).text().trim();this.$(d.currentTarget).parent().parent().siblings("button.btnAttributeType:first").html(c+' <span class="caret"></span>');this.attrsClone.at(b).set("type",c);if(c=="VARCHAR"){this.$(d.currentTarget).parent().parent().parent().parent().siblings("td.length-editable").attr("contenteditable","true");this.$(d.currentTarget).parent().parent().parent().parent().siblings("td.length-editable").text("50");this.attrsClone.at(b).set("length","50")}else{this.$(d.currentTarget).parent().parent().parent().parent().siblings("td.length-editable").text("");this.$(d.currentTarget).parent().parent().parent().parent().siblings("td.length-editable").attr("contenteditable","false")}},preventSubmission:function(b){b.preventDefault()}})})(jQuery);(function(a){app.omtg.ConnectionEditorView=Backbone.View.extend({id:"connection-editor",className:"modal fade",events:{"click #btnUpdate":"update","click #btnDelete":"detach","hidden.bs.modal":"teardown","click #ulConnectionSpatialRelation a":"selectSpatialRelation",submit:"preventSubmission"},initialize:function(b){this.template=_.template(a("#omtg-connection-editor-template").html());this.connection=b.connection;this.render()},render:function(){this.$el.html(this.template());var b=this.$("#connection-editor-form > fieldset");var f=this.connection.getType()[0];if(f=="spatial-association"){b.append(_.template(a("#omtg-connection-editor-spatial-relation-template").html()));this.descriptionLabel=this.connection.getOverlay("description-label");var d=app.canvas.get("diagrams").getAttrById(this.connection.sourceId,"type");var g=app.canvas.get("diagrams").getAttrById(this.connection.targetId,"type");if(d!="polygon"&&d!="planar-subdivision"){this.$("#contains").addClass("disabled");this.$("#containsproperly").addClass("disabled")}if(g!="polygon"&&g!="planar-subdivision"){this.$("#within").addClass("disabled")}var c=this.descriptionLabel.getLabel().split(" ")[0];if(c){this.$("#inputConnectionSpatialRelation").data("spatialrelation",c);this.$("#inputConnectionSpatialRelation").html(c)}else{this.$("#inputConnectionSpatialRelation").data("spatialrelation","Intersects");this.$("#inputConnectionSpatialRelation").html("Intersects")}if(c.toLowerCase()=="near"||c.toLowerCase()=="distant"){this.$("#inputConnectionDistance").prop("disabled",false);this.$("#inputConnectionDistance").val(this.connection.getParameter("distance"))}}if(f=="association"||f=="arc-network"||f=="arc-network-self"){b.append(_.template(a("#omtg-connection-editor-description-template").html()));this.descriptionLabel=this.connection.getOverlay("description-label");this.$("#inputConnectionDescription").val(this.descriptionLabel.getLabel())}if(f=="association"||f=="spatial-association"){b.append(_.template(a("#omtg-connection-editor-cardinalities-template").html()));var h=app.canvas.get("diagrams").getAttrById(this.connection.sourceId,"name");var e=app.canvas.get("diagrams").getAttrById(this.connection.targetId,"name");this.$("#CardA-label").text("Cardinality A ("+h+"):");this.cardLabelA=this.connection.getOverlay("cardinality-labelA");this.$("#inputMinA").val(this.connection.getParameter("minA"));this.$("#inputMaxA").val(this.connection.getParameter("maxA"));this.$("#CardB-label").text("Cardinality B ("+e+"):");this.cardLabelB=this.connection.getOverlay("cardinality-labelB");this.$("#inputMinB").val(this.connection.getParameter("minB"));this.$("#inputMaxB").val(this.connection.getParameter("maxB"))}if(f=="cartographic-generalization-disjoint"||f=="cartographic-generalization-overlapping"){b.append(_.template(a("#omtg-connection-editor-cartographic-template").html()));this.cartographicLabel=this.connection.getOverlay("cartographic-label");if(this.cartographicLabel.getLabel()=="scale"){this.$("#scaleRadio").prop("checked",true)}else{this.$("#shapeRadio").prop("checked",true)}}this.$el.modal({backdrop:"static",keyboard:false,show:true});return this},teardown:function(){this.$el.data("modal",null);this.remove()},update:function(){var e=this.connection.getType()[0];var d;if(e=="spatial-association"){d=this.$("#inputConnectionSpatialRelation").data("spatialrelation");if(d.toLowerCase()=="near"||d.toLowerCase()=="distant"){var i=this.$("#inputConnectionDistance").val().trim();if(!i||!(i>=0)){i=10}this.connection.setParameter("distance",i);this.descriptionLabel.setLabel(d+" ("+i+")")}else{this.descriptionLabel.setLabel(d)}}if(e=="association"||e=="arc-network"||e=="arc-network-self"){var f=this.$("#inputConnectionDescription").val().trim();this.descriptionLabel.setLabel(f)}if(e=="association"||e=="spatial-association"){var c=this.$("#inputMinA").val().trim();var h=this.$("#inputMaxA").val().trim();c=c>=0&&c!=""?c:"0";h=h>=1&&h!=""&&c<=h?h:"*";this.cardLabelA.setLabel(this.concatCardLabel(c,h));var b=this.$("#inputMinB").val().trim();var g=this.$("#inputMaxB").val().trim();b=b>=0&&b!=""?b:"0";g=g>=1&&g!=""&&b<=g?g:"*";this.cardLabelB.setLabel(this.concatCardLabel(b,g));this.connection.setParameter("minA",c);this.connection.setParameter("maxA",h);this.connection.setParameter("minB",b);this.connection.setParameter("maxB",g);app.plumbUtils.updateLabelsPosition(this.connection)}if(e=="cartographic-generalization-disjoint"||e=="cartographic-generalization-overlapping"){this.cartographicLabel.setLabel(this.$("input:radio[name=inlineRadioOptions]:checked").val())}app.plumbUtils.updateLabelsPosition(this.connection);app.canvasView.updateHistory()},detach:function(d){if(confirm(app.msgs.deleteConnection)){var c=this.connection.getType()[0];if(c=="cartographic-generalization-disjoint"||c=="cartographic-generalization-overlapping"){app.plumb.detachAllConnections(this.connection.getOverlay("cartographic-square").getElement())}else{if(c=="arc-network"||c=="arc-network-sibling"||c=="arc-network-self"||c=="arc-network-sibling-self"){var b=this.connection.getParameter("sibling");app.plumb.detach(b)}}app.plumb.detach(this.connection)}},concatCardLabel:function(c,b){if(c==b){return c}return c+".."+b},selectSpatialRelation:function(d){var c=this.$(d.currentTarget).html();this.$("#inputConnectionSpatialRelation").html(c);var b=this.$(d.currentTarget).data("spatialrelation").trim();this.$("#inputConnectionSpatialRelation").data("spatialrelation",b);if(b.toLowerCase()=="near"||b.toLowerCase()=="distant"){this.$("#inputConnectionDistance").prop("disabled",false);this.$("#inputConnectionDistance").val(this.connection.getParameter("distance"))}else{this.$("#inputConnectionDistance").prop("disabled",true);this.$("#inputConnectionDistance").val("");this.connection.setParameter("distance","")}},preventSubmission:function(b){b.preventDefault()}})})(jQuery);(function(a){app.ToolView=Backbone.View.extend({events:{click:"clicked"},initialize:function(){this.template=_.template(a("#tool-template").html());this.listenTo(this.model,"change:active",this.toggle)},render:function(){var b=this.template(this.model.toJSON());this.setElement(b);return this},clicked:function(){this.model.toggleActive()},toggle:function(){if(this.model.get("active")){this.$el.addClass("active");app.canvas.set("activeTool",this.model)}else{this.$el.removeClass("active");app.canvas.set("activeTool",null)}}})})(jQuery);(function(a){app.ToolsView=Backbone.View.extend({render:function(){this.$el.empty();this.model.each(function(b){var c=new app.ToolView({model:b});this.$el.append(c.render().el)},this);return this}})})(jQuery);(function(a){app.ToolboxView=Backbone.View.extend({tagName:"div",className:"widget",initialize:function(){this.template=_.template(a("#toolbox-template").html())},render:function(){this.$el.html(this.template(this.model.toJSON()));var b=new app.ToolsView({model:this.model.get("tools")});b.$el=this.$(".widget-content");b.render();return this}})})(jQuery);(function(a){app.ToolboxesView=Backbone.View.extend({initialize:function(){this.render()},render:function(){this.$el.empty();this.model.each(function(c){var b=new app.ToolboxView({model:c});this.$el.append(b.render().el)},this)}})})(jQuery);(function(a){app.XMLImporterView=Backbone.View.extend({id:"xml-importer",className:"modal fade",events:{"click #btnImport":"importXML","hidden.bs.modal":"teardown","change #js-upload-files":"uploadFile","load #js-upload-files":"importXML"},initialize:function(b){this.template=_.template(a("#xmlimporter-template").html());this.render()},render:function(){this.$el.html(this.template());this.$el.modal({backdrop:"static",keyboard:false,show:true});return this},teardown:function(){this.$el.data("modal",null);this.remove()},uploadFile:function(c){var e=c.target.files[0];var b=new FileReader();var d=this;b.readAsText(e);b.onload=function(){a.ajax({url:"XMLImporter",type:"POST",data:b.result,contentType:"application/json; charset=UTF-8",complete:function(g,h,f){d.allowImport(g.status);d.validXML=b.result}})}},importXML:function(){var b=app.XMLParser;b.parseOMTGSchema(this.validXML);app.canvasView.updateHistory();this.teardown()},allowImport:function(b){if(b==202){this.$("#btnImport").removeClass("disabled")}else{this.$("#btnImport").addClass("disabled")}}})})(jQuery);(function(a){app.NavbarView=Backbone.View.extend({events:{"click #btnImportXML":"importXML","click #btnExportXML":"exportXML","click #btnExportSQL":"exportSQL","click #btnExportPostgis":"exportPostgis","click #btnPrint":"print","click #btnAbout":"showAbout","change #tgglGrid":"changeGrid","change #tgglShadow":"changeDiagramShadow","change #tgglSnapToGrid":"changeSnapToGrid","click #dropSettings":"dropSettingsClick"},importXML:function(){if(app.canvas.get("diagrams").length>0){alert(app.msgs.NOT_EMPTY_PROJECT);return}new app.XMLImporterView()},exportXML:function(){if(app.canvas.get("diagrams").length==0){alert(app.msgs.EMPTY_PROJECT);return}app.plumb.doWhileSuspended(function(){var c=app.canvas.toXML();var b=new Blob([c]);saveAs(b,"OMTG.xml")},false)},exportSQL:function(){if(app.canvas.get("diagrams").length==0){alert(app.msgs.EMPTY_PROJECT);return}app.plumb.doWhileSuspended(function(){var b=app.canvas.toXML();a.ajax({url:"omtg2sql",type:"POST",data:b,contentType:"application/json; charset=UTF-8",success:function(g,h,f){var c=new Uint8Array(g.length);for(var e=0;e<g.length;e++){c[e]=g.charCodeAt(e)&255}var d=new Blob([c]);saveAs(d,"OMTG-Oracle.zip")},error:function(e,c,d){alert("The request failed.")}})},false)},exportPostgis:function(){if(app.canvas.get("diagrams").length==0){alert(app.msgs.EMPTY_PROJECT);return}app.plumb.doWhileSuspended(function(){var b=app.canvas.toXML();a.ajax({url:"omtg2postgis",type:"POST",data:b,contentType:"application/json; charset=UTF-8",success:function(g,h,f){var c=new Uint8Array(g.length);for(var e=0;e<g.length;e++){c[e]=g.charCodeAt(e)&255}var d=new Blob([c]);saveAs(d,"OMTG-Postgis.zip")},error:function(e,c,d){alert("The request failed.")}})},false)},print:function(){app.canvasView.print()},showAbout:function(){new app.AboutView()},dropSettingsClick:function(){event.stopPropagation();if(event.target.nodeName=="LABEL"||event.target.nodeName=="SPAN"){a(event.target).parent().parent().find("input").bootstrapToggle("toggle")}else{if(event.target.nodeName=="A"){a(event.target).find("input").bootstrapToggle("toggle")}}},changeGrid:function(){app.canvas.set("grid",a("#tgglGrid").prop("checked"))},changeDiagramShadow:function(){app.canvas.set("diagramShadow",a("#tgglShadow").prop("checked"))},changeSnapToGrid:function(){if(a("#tgglSnapToGrid").prop("checked")){app.canvas.set("snapToGrid",10)}else{app.canvas.set("snapToGrid",1)}}})})(jQuery);(function(a){app.CanvasView=Backbone.View.extend({events:{click:"clicked",contextmenu:"openContextMenu"},initialize:function(){this.listenTo(this.model.get("diagrams"),"add",this.addOMTGDiagram);this.listenTo(this.model.get("diagrams"),"change",this.updateHistory);this.listenTo(this.model,"change:activeTool",this.setCursor);this.listenTo(this.model,"change:grid",this.toggleGrid);this.listenTo(this.model,"change:diagramShadow",this.toggleDiagramShadow);this.listenTo(this.model,"updateHistory",this.updateHistory)},clearCanvas:function(){app.plumb.detachEveryConnection({fireEvent:false});app.plumb.deleteEveryEndpoint();this.model.get("diagrams").removeAll()},updateHistory:function(){this.model.get("undoManager").update()},redoHistory:function(){var c=this.model.get("undoManager");if(c.hasRedo()){this.clearCanvas();var b=c.redo();if(b){app.XMLParser.parseOMTGSchema(b)}}},undoHistory:function(){var c=this.model.get("undoManager");if(c.hasUndo()){this.clearCanvas();var b=c.undo();if(b){app.XMLParser.parseOMTGSchema(b)}}},clicked:function(e){if(e&&e.target&&!a(e.target).is(".canvas")){return}var c=this.model.get("activeTool");if(c){var d=app.canvas.get("snapToGrid");if(c.get("model")=="omtgDiagram"){var b=new app.omtg.Diagram({type:c.get("name"),left:Math.round(e.offsetX/d)*d,top:Math.round(e.offsetY/d)*d});this.model.get("diagrams").add(b);this.updateHistory()}c.toggleActive();this.model.set("activeTool",null)}this.model.get("diagrams").unselectAll()},setCursor:function(){var b=this.model.get("activeTool");if(b&&b.get("model")=="omtgDiagram"){this.$el.css("cursor","copy")}else{this.$el.css("cursor","default")}},toggleGrid:function(){if(this.model.get("grid")){this.$el.addClass("canvas-background")}else{this.$el.removeClass("canvas-background")}},toggleDiagramShadow:function(){if(this.model.get("diagramShadow")){this.$el.find(".diagram-container").addClass("diagram-container-shadow")}else{this.$el.find(".diagram-container").removeClass("diagram-container-shadow")}},addOMTGDiagram:function(b){app.plumb.setSuspendDrawing(true);var c=new app.omtg.DiagramView({model:b});var d=c.render().el;this.$el.append(d);app.plumb.draggable(d,{containment:"#canvas",scroll:true,drag:function(g,f){if(a(".cartographic-square").length>0){app.plumb.repaintEverything()}}});app.plumb.makeSource(d,{filter:function(){var e=app.canvas.get("activeTool");return e!=null&&e.get("model")=="omtgRelation"}});app.plumb.makeTarget(d);app.plumb.setSuspendDrawing(false,true)},print:function(){this.model.get("diagrams").unselectAll();this.$el.children().printThis({debug:false,importCSS:true,importStyle:false,printContainer:true})},openContextMenu:function(b){if(b&&b.target&&!a(b.target).is(".canvas")){return}b.preventDefault();app.contextMenuView=new app.ContextMenuView({left:b.pageX,top:b.pageY,offsetTop:b.offsetY,offsetLeft:b.offsetX})}})})(jQuery);(function(a){app.AboutView=Backbone.View.extend({id:"welcome-modal",className:"modal fade",events:{"hidden.bs.modal":"teardown"},initialize:function(b){this.template=_.template(a("#about-template").html());this.render()},render:function(){this.$el.html(this.template());this.$el.modal({backdrop:"static",keyboard:true,show:true});return this},teardown:function(){this.$el.data("modal",null);this.remove()}})})(jQuery);(function(a){app.ContextMenuView=Backbone.View.extend({className:"context-menu",parentSelector:"body",events:{"click  #cmEdit":"editDiagram","click  #cmDelete":"deleteDiagram","click  #cmToFront":"bringToFront","click  #cmToBack":"sendToBack","click  #cmCopy":"copyDiagram","click  #cmPaste":"pasteDiagram","click  #cmDuplicate":"duplicateDiagram","click  #cmUndo":"undo","click  #cmRedo":"redo",click:"destroyMenu",contextmenu:"rightClick"},initialize:function(b){if(b.diagramView!=null){this.template=_.template(a("#contextmenu-diagram-template").html());this.diagramView=b.diagramView}else{this.template=_.template(a("#contextmenu-canvas-template").html());this.offsetTop=b.offsetTop;this.offsetLeft=b.offsetLeft}this.left=b.left;this.top=b.top;this.render()},render:function(){this.$el.html(this.template());this.$el.appendTo(this.parentSelector);if(this.diagramView==null){if(app.canvas.get("clipboard")==null){this.$("#cmPaste").parent().addClass("disabled")}var b=app.canvas.get("undoManager");if(!b.hasUndo()){this.$("#cmUndo").parent().addClass("disabled")}if(!b.hasRedo()){this.$("#cmRedo").parent().addClass("disabled")}}this.$(".context-menu-content").css({top:this.top+"px",left:this.left+"px"});return this},destroyMenu:function(){this.undelegateEvents();this.$el.removeData().unbind();this.remove();Backbone.View.prototype.remove.call(this)},editDiagram:function(){this.diagramView.edit()},deleteDiagram:function(){this.diagramView.deleteDiagram()},bringToFront:function(){this.diagramView.bringToFront()},sendToBack:function(){this.diagramView.sendToBack()},duplicateDiagram:function(){app.canvas.duplicateDiagram(this.diagramView.model)},copyDiagram:function(){app.canvas.copyDiagram(this.diagramView.model)},pasteDiagram:function(b){if(app.canvas.hasClipboard()){app.canvas.pasteDiagram(this.offsetTop,this.offsetLeft)}else{b.stopPropagation()}},rightClick:function(b){b.preventDefault();this.destroyMenu()},undo:function(b){if(app.canvas.get("undoManager").hasUndo()){app.canvasView.undoHistory()}else{b.stopPropagation()}},redo:function(b){if(app.canvas.get("undoManager").hasRedo()){app.canvasView.redoHistory()}else{b.stopPropagation()}}})})(jQuery);jsPlumb.ready(function(){var h={stroke:"black",strokeWidth:2};var g={stroke:"black",strokeWidth:2,dashstyle:"4 3"};var d={stroke:"#1e8151",strokeWidth:4,outlineStroke:"transparent",outlineWidth:2};var c=[["Diamond",{length:35,width:18,location:35,paintStyle:{stroke:"black",fill:"white"}}]];var a=function(i){if(i=="generalization-disjoint-partial"){return["Image",{src:"imgs/omtg/triangle-white.png",cssClass:"triangle-endpoint"}]}if(i=="generalization-overlapping-partial"){return["Image",{src:"imgs/omtg/triangle-black.png",cssClass:"triangle-endpoint"}]}if(i=="generalization-disjoint-total"){return["Image",{src:"imgs/omtg/triangle-circle-white.png",cssClass:"triangle-endpoint"}]}if(i=="generalization-overlapping-total"){return["Image",{src:"imgs/omtg/triangle-circle-black.png",cssClass:"triangle-endpoint"}]}};var b=function(i){if(i=="total"){return[0.5,1,0,1,0,20]}else{return[0.5,1,0,1,0,11]}};var f=function(i){if(i=="cartographic-generalization-overlapping"){return["Image",{src:"imgs/omtg/square-black.png",cssClass:"square-overlay"}]}if(i=="cartographic-generalization-disjoint"){return["Image",{src:"imgs/omtg/square-white.png",cssClass:"square-overlay"}]}};var e=function(j,i){return["Custom",{create:function(k){return $('<img class="cartographic-square" src="imgs/omtg/square-'+j+'.png" alt="'+j+' square" width="16px" height="16px" >')},id:"cartographic-square",cssClass:"cartographic-square",location:i}]};app.plumb=jsPlumb.getInstance({Anchor:"Continuous",Connector:"Flowchart",Container:"canvas",DragOptions:{cursor:"pointer",zIndex:2000},Endpoint:"Blank"});app.plumb.registerConnectionTypes({association:{paintStyle:h,hoverPaintStyle:d,overlays:[["Label",{label:"",location:0.5,id:"description-label",cssClass:"description-label"}],["Label",{label:"0..*",location:30,id:"cardinality-labelA",cssClass:"cardinality-label"}],["Label",{label:"0..*",location:-30,id:"cardinality-labelB",cssClass:"cardinality-label"}],["Custom",{create:function(i){return $("<img src='imgs/relation/description-arrow.png' alt='Arrow of the relation'>")},location:0.5,id:"description-arrow",cssClass:"description-arrow"}]],parameters:{minA:"0",maxA:"*",minB:"0",maxB:"*"}},"spatial-association":{paintStyle:g,hoverPaintStyle:d,overlays:[["Label",{label:"Intersects",location:0.5,id:"description-label",cssClass:"description-label"}],["Label",{label:"0..*",location:30,id:"cardinality-labelA",cssClass:"cardinality-label"}],["Label",{label:"0..*",location:-30,id:"cardinality-labelB",cssClass:"cardinality-label"}],["Custom",{create:function(i){return $("<img src='imgs/relation/description-arrow.png' alt='Arrow of the relation'>")},location:0.5,id:"description-arrow",cssClass:"description-arrow"}]],parameters:{minA:"0",maxA:"*",minB:"0",maxB:"*",distance:""}},aggregation:{paintStyle:h,hoverPaintStyle:d,overlays:c},"spatial-aggregation":{paintStyle:g,hoverPaintStyle:d,overlays:c},"generalization-disjoint-partial":{paintStyle:h,hoverPaintStyle:d,parameters:{participation:"partial",disjointness:"disjoint"}},"generalization-overlapping-partial":{paintStyle:h,hoverPaintStyle:d,parameters:{participation:"partial",disjointness:"overlapping"}},"generalization-disjoint-total":{paintStyle:h,hoverPaintStyle:d,parameters:{participation:"total",disjointness:"disjoint"}},"generalization-overlapping-total":{paintStyle:h,hoverPaintStyle:d,parameters:{participation:"total",disjointness:"overlapping"}},"generalization-leg":{paintStyle:h,hoverPaintStyle:d},"arc-network":{paintStyle:g,hoverPaintStyle:d,overlays:[["Label",{label:"network",location:0.5,id:"description-label",cssClass:"arc-network-label"}]]},"arc-network-sibling":{paintStyle:g,hoverPaintStyle:d},"arc-network-self":{paintStyle:g,hoverPaintStyle:d,overlays:[["Label",{label:"network",location:0.4,id:"description-label",cssClass:"arc-network-self-label"}]]},"arc-network-sibling-self":{paintStyle:g,hoverPaintStyle:d},"cartographic-generalization-disjoint":{paintStyle:g,hoverPaintStyle:d,overlays:[e("white",70),["Label",{label:"scale",location:0.5,id:"cartographic-label",cssClass:"cartographic-label"}]],parameters:{disjointness:"disjoint"}},"cartographic-generalization-overlapping":{paintStyle:g,hoverPaintStyle:d,overlays:[e("black",70),["Label",{label:"scale",location:0.5,id:"cartographic-label",cssClass:"cartographic-label"}]],parameters:{disjointness:"overlapping"}},"cartographic-leg":{paintStyle:g,hoverPaintStyle:d}});app.plumb.bind("connectionDrag",function(i){var j=app.canvas.get("activeTool");if(j!=null&&j.get("model")=="omtgRelation"){var k=j.get("name");if(k=="arc-network"){i.setConnector("Straight")}i.setType(k);if(k=="association"||k=="spatial-association"||k=="arc-network"){i.hideOverlays()}return}if(i.source.classList.contains("cartographic-square")){i.setType("cartographic-leg");return}if(jQuery.inArray("generalization-leg",i.getType())!=-1){i.setType("generalization-leg");return}});app.plumb.bind("connection",function(l,i){if(l.connection.getType().length>1){l.connection.removeType("default");l.connection.removeType("")}var q=l.connection.getType()[0];l.connection.showOverlays();switch(q){case"association":if(l.connection.sourceId==l.connection.targetId){app.plumb.detach(l.connection,{fireEvent:false});var u=app.plumb.connect({source:l.connection.sourceId,target:l.connection.targetId,anchors:[[0,0.6,-1,0],[0.5,1,0,1]],fireEvent:false});u.setConnector(["Flowchart",{stub:[50,50],alwaysRespectStubs:true}]);u.setType(q);app.plumbUtils.updateLabelsPosition(u)}else{app.plumbUtils.updateLabelsPosition(l.connection)}break;case"spatial-association":app.plumbUtils.updateLabelsPosition(l.connection);break;case"arc-network":if(l.connection.sourceId==l.connection.targetId){app.plumb.detach(l.connection,{fireEvent:false});var u=app.plumb.connect({source:l.connection.sourceId,target:l.connection.targetId,anchors:[[0.35,1,0,1],[1,0.5,1,0]],fireEvent:false});var v=app.plumb.connect({source:l.connection.sourceId,target:l.connection.targetId,anchors:[[0.5,1,0,1],[1,0.75,1,0]],fireEvent:false});u.setConnector(["Flowchart",{stub:[50,50],alwaysRespectStubs:true}]);v.setConnector(["Flowchart",{stub:[25,25],alwaysRespectStubs:true}]);u.setType("arc-network-self");v.setType("arc-network-sibling-self");v.setParameter("sibling",u);u.setParameter("sibling",v)}else{var k=l.connection.source.getBoundingClientRect().width;var m=l.connection.source.getBoundingClientRect().height;var s=l.connection.target.getBoundingClientRect().width;var p=l.connection.target.getBoundingClientRect().height;var t=app.plumbUtils.NETWORK_DIST/k;var r=app.plumbUtils.NETWORK_DIST/m;var o=app.plumbUtils.NETWORK_DIST/s;var n=app.plumbUtils.NETWORK_DIST/p;app.plumb.detach(l.connection,{fireEvent:false});var u=app.plumb.connect({source:l.connection.sourceId,target:l.connection.targetId,fireEvent:false});var v=app.plumb.connect({source:l.connection.sourceId,target:l.connection.targetId,fireEvent:false});u.setConnector("Straight");v.setConnector("Straight");u.setType("arc-network");v.setType("arc-network-sibling");u.endpoints[0].setAnchor([[0.5+t,0,0,-1],[1,0.5+r,1,0],[0.5-t,1,0,1],[0,0.5-r,-1,0]]);u.endpoints[1].setAnchor([[0.5-o,0,0,-1],[1,0.5-n,1,0],[0.5+o,1,0,1],[0,0.5+n,-1,0]]);v.endpoints[0].setAnchor([[0.5-t,0,0,-1],[1,0.5-r,1,0],[0.5+t,1,0,1],[0,0.5+r,-1,0]]);v.endpoints[1].setAnchor([[0.5+o,0,0,-1],[1,0.5+n,1,0],[0.5-o,1,0,1],[0,0.5-n,-1,0]]);v.setParameter("sibling",u);u.setParameter("sibling",v);app.plumbUtils.updateLabelsPosition(u)}break;case"generalization-disjoint-partial":case"generalization-disjoint-total":case"generalization-overlapping-partial":case"generalization-overlapping-total":var x=l.connection.getParameter("participation");var j=l.connection.getParameter("disjointness");app.plumb.detach(l.connection,{fireEvent:false});var w=app.plumb.addEndpoint(l.connection.sourceId,{anchor:b(x),connectionType:"generalization-leg",endpoint:a(q),isSource:true,isTarget:false,maxConnections:-1,uniqueEndpoint:true,parameters:{participation:x,disjointness:j}});var u=app.plumb.connect({anchors:["Bottom","Top"],source:w,target:l.connection.targetId});u.setType(q);u.setConnector(["Flowchart",{stub:[50,30],alwaysRespectStubs:true}]);break;case"generalization-leg":l.connection.endpoints[1].setAnchor("Top");l.connection.setConnector(["Flowchart",{stub:[50,30],alwaysRespectStubs:true}]);break;case"cartographic-generalization-disjoint":case"cartographic-generalization-overlapping":app.plumb.detach(l.connection,{fireEvent:false});var u=app.plumb.connect({source:l.connection.sourceId,target:l.connection.targetId,anchors:["Bottom","Top"],fireEvent:false});u.setConnector(["Flowchart",{stub:[70,50],alwaysRespectStubs:true}]);u.setType(q);app.plumb.makeSource(u.getOverlay("cartographic-square").getElement(),{anchor:["Right","Left"]});break;case"cartographic-leg":l.connection.endpoints[1].setAnchor("Top");l.connection.setConnector(["Flowchart",{stub:[0,50],alwaysRespectStubs:true}]);break}app.canvasView.updateHistory();app.relationshipTools.deactivateAll();app.classTools.deactivateAll()});app.plumb.bind("beforeDrop",function(l){var j=l.connection.getType()[0];if((j!="arc-network"&&j!="association")&&l.sourceId==l.targetId){return false}var i=app.canvas.get("diagrams").getAttrById(l.sourceId,"type");var k=app.canvas.get("diagrams").getAttrById(l.targetId,"type");switch(j){case"generalization-disjoint-partial":case"generalization-overlapping-partial":case"generalization-disjoint-total":case"generalization-overlapping-total":return i==k;case"aggregation":return(i=="conventional")||(k=="conventional");case"cartographic-generalization-disjoint":case"cartographic-generalization-overlapping":return(i=="conventional")&&(k!="conventional");case"cartographic-leg":return k!="conventional";case"spatial-association":case"spatial-aggregation":return(i!="conventional")&&(k!="conventional");case"arc-network":return(l.connection.sourceId==l.connection.targetId&&(i=="bi-line"||i=="un-line"))||(i=="node"&&(k=="bi-line"||k=="un-line"))||(k=="node"&&(i=="bi-line"||i=="un-line"))}return true});app.plumb.bind("dblclick",function(j,i){var m=j;if(j instanceof jsPlumb.Overlays.Label){m=j.component}var k=m.getType()[0];if(k=="arc-network-sibling"||k=="arc-network-sibling-self"){m=m.getParameter("sibling")}if(k=="aggregation"||k=="spatial-aggregation"||k=="cartographic-leg"){if(confirm(app.msgs.DELETE_CONNECTION)){app.plumb.detach(m)}}else{if(k=="generalization-disjoint-partial"||k=="generalization-disjoint-total"||k=="generalization-overlapping-partial"||k=="generalization-overlapping-total"){if(confirm(app.msgs.DELETE_CONNECTION)){var l=m.endpoints[0];app.plumb.detach(m);if(l.getAttachedElements().length==0){app.plumb.deleteEndpoint(l)}else{l.getAttachedElements()[0].setType(k);l.getAttachedElements()[0].removeAllOverlays()}}}else{if(k=="generalization-leg"){if(confirm(app.msgs.DELETE_CONNECTION)){var l=m.endpoints[0];app.plumb.detach(m);if(l.getAttachedElements().length==0){app.plumb.deleteEndpoint(l)}}}else{new app.omtg.ConnectionEditorView({connection:m})}}}});app.plumb.bind("connectionDetached",function(j,i){app.canvasView.updateHistory()})});"use strict";app.plumbUtils={NETWORK_DIST:15,setAssociationLabelClass:function(a,b,c){var d=a.getOverlay(b);d.removeClass("cardinality-left");d.removeClass("cardinality-right");d.removeClass("cardinality-top");d.removeClass("cardinality-bottom");switch(c){case"left":d.addClass("cardinality-left");break;case"right":d.addClass("cardinality-right");break;case"top":d.addClass("cardinality-top");break;case"bottom":d.addClass("cardinality-bottom");break;default:d.addClass("cardinality-top");d.addClass("cardinality-left")}},calculateWordOffset:function(d,b,e){var c=1;var a=40;return(e-b)*(d-c)/(a-c)+b},getPositionAtCenter:function(a){var b=a.getBoundingClientRect();return{x:b.left+b.width/2,y:b.top+b.height/2}},getDistanceBetweenElements:function(e,d){var c=this.getPositionAtCenter(e);var f=this.getPositionAtCenter(d);return Math.sqrt(Math.pow(c.x-f.x,2)+Math.pow(c.y-f.y,2))},setOverlayTransformation:function(e,d,c,f){e.style.webkitTransform="translate("+d+"px, "+c+"px) rotate("+f+"rad)";e.style.mozTransform="translate("+d+"px, "+c+"px) rotate("+f+"rad)";e.style.msTransform="translate("+d+"px, "+c+"px) rotate("+f+"rad)";e.style.oTransform="translate("+d+"px, "+c+"px) rotate("+f+"rad)";e.style.transform="translate("+d+"px, "+c+"px) rotate("+f+"rad)"},updateLabelsPosition:function(m){var h=m.getType();if(h=="association"||h=="spatial-association"){var k=m.getOverlay("description-label");var c=k.getElement();var f=m.getOverlay("description-arrow");var n=m.connector.pointOnPath(k.loc);var d=m.connector.findSegmentForPoint(n.x,n.y);if(m.sourceId==m.targetId){this.setAssociationLabelClass(m,"cardinality-labelA","left");this.setAssociationLabelClass(m,"cardinality-labelB","bottom");this.setOverlayTransformation(c,40+(-1)*c.offsetWidth/2,-23,0);this.setOverlayTransformation(f.getElement(),40+(-1/2)*f.getElement().width,-31,0)}else{var l=m.endpoints[0]._continuousAnchorEdge;var s=m.endpoints[1]._continuousAnchorEdge;this.setAssociationLabelClass(m,"cardinality-labelA",l);this.setAssociationLabelClass(m,"cardinality-labelB",s);var j=this.getPositionAtCenter(m.source);var q=this.getPositionAtCenter(m.target);if((d.y1==d.y2&&Math.abs(d.x1-d.x2)>c.offsetWidth)||(d.y1!=d.y2&&Math.abs(d.y1-d.y2)<=f.getElement().width)){var u=Math.PI;if(j.x<=q.x){u=0}this.setOverlayTransformation(c,(-1)*c.offsetWidth/2,(-1)*c.offsetHeight/2-11-Math.abs(d.y1-d.y2)/2,0);this.setOverlayTransformation(f.getElement(),(-1/2)*f.getElement().width,(-1)*c.offsetHeight-9-Math.abs(d.y1-d.y2)/2,u)}else{var u=(-1)*Math.PI/2;if(j.y<=q.y){u*=-1}this.setOverlayTransformation(c,22+Math.abs(d.x1-d.x2)/2,(-1)*c.offsetHeight/2,0);this.setOverlayTransformation(f.getElement(),-6+Math.abs(d.x1-d.x2)/2,(-1/2)*f.getElement().height,u)}}if(k.getLabel()==""){k.hide();f.hide()}else{k.show();f.show()}}else{if(h=="arc-network"){this.repaintNetworkAnchors(m);var i=m.getConnector().path.getBoundingClientRect();var y=Math.asin((i.bottom-i.top)/Math.sqrt((i.bottom-i.top)*(i.bottom-i.top)+(i.left-i.right)*(i.left-i.right)));var o=this.getDistanceBetweenElements(m.getConnector().path,m.getParameter("sibling").getConnector().path);var t=parseInt(m.endpoints[0].element.style.left.replace("px",""));var g=parseInt(m.endpoints[0].element.style.top.replace("px",""));var r=parseInt(m.endpoints[1].element.style.left.replace("px",""));var e=parseInt(m.endpoints[1].element.style.top.replace("px",""));var k=m.getOverlay("description-label").getElement();if(t<=r&&g>=e){var v=Math.PI/2-y;var x=0-k.offsetWidth/2-Math.cos(v)*o/2;var w=0-k.offsetHeight/2-Math.sin(v)*o/2;this.setOverlayTransformation(k,x,w,-1*y)}else{if(t<=r&&g<e){var v=Math.PI/2-(-1)*y;var x=0-k.offsetWidth/2-Math.cos(v)*o/2;var w=0-k.offsetHeight/2-Math.sin(v)*o/2;this.setOverlayTransformation(k,x,w,y)}else{if(t>r&&g<e){var v=Math.PI/2-y;var x=0-k.offsetWidth/2+Math.cos(v)*o/2;var w=0-k.offsetHeight/2+Math.sin(v)*o/2;this.setOverlayTransformation(k,x,w,-1*y)}else{var v=Math.PI/2-y;var x=0-k.offsetWidth/2-Math.cos(v)*o/2;var w=0-k.offsetHeight/2+Math.sin(v)*o/2;this.setOverlayTransformation(k,x,w,y)}}}}}},repaintNetworkAnchors:function(a){var g=a.getType();if(g=="arc-network"){var b=a.source.getBoundingClientRect().width;var c=a.source.getBoundingClientRect().height;var i=a.target.getBoundingClientRect().width;var f=a.target.getBoundingClientRect().height;var j=this.NETWORK_DIST/b;var h=this.NETWORK_DIST/c;var e=this.NETWORK_DIST/i;var d=this.NETWORK_DIST/f;var k=a.getParameter("sibling");a.endpoints[0].setAnchor([[0.5+j,0,0,-1],[1,0.5+h,1,0],[0.5-j,1,0,1],[0,0.5-h,-1,0]]);a.endpoints[1].setAnchor([[0.5-e,0,0,-1],[1,0.5-d,1,0],[0.5+e,1,0,1],[0,0.5+d,-1,0]]);k.endpoints[0].setAnchor([[0.5-j,0,0,-1],[1,0.5-h,1,0],[0.5+j,1,0,1],[0,0.5+h,-1,0]]);k.endpoints[1].setAnchor([[0.5+e,0,0,-1],[1,0.5+d,1,0],[0.5-e,1,0,1],[0,0.5-d,-1,0]])}},repaintAllAnchors:function(){var b=app.plumb.getConnections();for(var a=0;a<b.length;a++){if(b[a].getType()=="arc-network"){this.repaintNetworkAnchors(b[a])}}},repaintAllLabels:function(){var b=app.plumb.getConnections();for(var a=0;a<b.length;a++){this.updateLabelsPosition(b[a])}}};"use strict";app.XMLParser={parseOMTGSchema:function(a){app.plumb.setSuspendDrawing(true);var d=new DOMParser();var c=d.parseFromString(a,"text/xml");this.diagramMap={};var e=c.getElementsByTagName("classes")[0].childNodes;var b=c.getElementsByTagName("relationships")[0].childNodes;this.parseOMTGDiagrams(e);this.parseOMTGConnections(b);app.plumb.setSuspendDrawing(false,true);app.plumbUtils.repaintAllAnchors();app.plumbUtils.repaintAllLabels()},parseOMTGDiagrams:function(d){for(var b=0;b<d.length;b++){var c=d.item(b);var a=this.parseOMTGDiagram(c);app.canvas.get("diagrams").add(a)}},parseOMTGDiagram:function(d){var c=d.childNodes;var a=new app.omtg.Diagram();for(var b=0;b<c.length;b++){switch(c.item(b).nodeName){case"name":a.set("name",c.item(b).firstChild.nodeValue);break;case"top":a.set("top",parseFloat(c.item(b).firstChild.nodeValue));break;case"left":a.set("left",parseFloat(c.item(b).firstChild.nodeValue));break;case"type":a.set("type",c.item(b).firstChild.nodeValue);break;case"attributes":a.set("attributes",this.parseOMTGAttributes(c.item(b)));break}}this.diagramMap[a.get("name")]=a.get("id");return a},parseOMTGAttributes:function(d){var c=d.childNodes;var a=new app.omtg.Attributes();for(var b=0;b<c.length;b++){var e=this.parseOMTGAttribute(c.item(b));a.add(e)}return a},parseOMTGAttribute:function(c){var b=c.childNodes;var d=new app.omtg.Attribute();for(var a=0;a<b.length;a++){switch(b.item(a).nodeName){case"id":d.set("id",b.item(a).firstChild.nodeValue);break;case"name":d.set("name",b.item(a).firstChild.nodeValue);break;case"type":d.set("type",b.item(a).firstChild.nodeValue);break;case"default":d.set("defaultValue",b.item(a).firstChild.nodeValue);break;case"key":d.set("isKey",b.item(a).firstChild.nodeValue);break;case"length":d.set("length",b.item(a).firstChild.nodeValue);break;case"scale":d.set("scale",b.item(a).firstChild.nodeValue);break;case"size":d.set("size",b.item(a).firstChild.nodeValue);break;case"not-null":d.set("isNotNull",b.item(a).firstChild.nodeValue);break;case"domain":d.set("domain",this.parseOMTGAttributeDomain(b.item(a)));break}}return d},parseOMTGAttributeDomain:function(a){return null},parseOMTGConnections:function(c){for(var a=0;a<c.length;a++){var b=c.item(a);this.parseOMTGConnection(b)}},parseOMTGConnection:function(a){switch(a.nodeName){case"conventional":var q=this.getValue(a.childNodes[0].firstChild);var e=a.childNodes[1].firstChild.nodeValue;var l=a.childNodes[3].firstChild.nodeValue;var z=a.childNodes[2];var x=a.childNodes[4];var k;if(e==l){k=app.plumb.connect({source:this.diagramMap[e],target:this.diagramMap[l],anchors:[[0,0.6,-1,0],[0.5,1,0,1]],fireEvent:false});k.setConnector(["Flowchart",{stub:[50,50],alwaysRespectStubs:true}])}else{k=app.plumb.connect({source:this.diagramMap[e],target:this.diagramMap[l],fireEvent:false})}k.setType("association");k.getOverlay("description-label").setLabel(q);this.parseOMTGConnectionCardinality(z,k,"A");this.parseOMTGConnectionCardinality(x,k,"B");break;case"topological":var b=this.getValue(a.childNodes[0].firstChild.firstChild);var e=a.childNodes[1].firstChild.nodeValue;var l=a.childNodes[3].firstChild.nodeValue;var z=a.childNodes[2];var x=a.childNodes[4];var k=app.plumb.connect({source:this.diagramMap[e],target:this.diagramMap[l],fireEvent:false});k.setType("spatial-association");if(b.toLowerCase()=="near"||b.toLowerCase()=="distant"){var g=this.getValue(a.childNodes[0].childNodes[1].firstChild);k.setParameter("distance",g);k.getOverlay("description-label").setLabel(b+" ("+g+")")}else{k.getOverlay("description-label").setLabel(b)}this.parseOMTGConnectionCardinality(z,k,"A");this.parseOMTGConnectionCardinality(x,k,"B");break;case"conventional-aggregation":var e=a.childNodes[0].firstChild.nodeValue;var l=a.childNodes[1].firstChild.nodeValue;var k=app.plumb.connect({source:this.diagramMap[e],target:this.diagramMap[l],fireEvent:false});k.setType("aggregation");break;case"spatial-aggregation":var e=a.childNodes[0].firstChild.nodeValue;var l=a.childNodes[1].firstChild.nodeValue;var k=app.plumb.connect({source:this.diagramMap[e],target:this.diagramMap[l],fireEvent:false});k.setType("spatial-aggregation");break;case"network":var q=this.getValue(a.childNodes[0].firstChild);var e=a.childNodes[1].firstChild.nodeValue;var l=a.childNodes[2].firstChild.nodeValue;var f="arc-network";var y="arc-network-sibling";var m=["Continuous","Continuous"];var s=["Continuous","Continuous"];var d="Straight";var o="Straight";if(e==l){f="arc-network-self";y="arc-network-sibling-self";m=[[0.35,1,0,1],[1,0.5,1,0]];s=[[0.5,1,0,1],[1,0.75,1,0]];d=["Flowchart",{stub:[50,50],alwaysRespectStubs:true}];o=["Flowchart",{stub:[25,25],alwaysRespectStubs:true}]}var k=app.plumb.connect({source:this.diagramMap[e],target:this.diagramMap[l],anchors:m,fireEvent:false});k.setConnector(d);k.setType(f);k.getOverlay("description-label").setLabel(q);var u=app.plumb.connect({source:this.diagramMap[e],target:this.diagramMap[l],anchors:s,fireEvent:false});u.setConnector(o);u.setType(y);k.setParameter("sibling",u);u.setParameter("sibling",k);break;case"conceptual-generalization":var e=a.childNodes[0].firstChild.nodeValue;var p=a.childNodes[2].firstChild.nodeValue;var l=a.childNodes[3].childNodes[0].firstChild.nodeValue;var w=a.childNodes[3].childNodes;var k=app.plumb.connect({source:this.diagramMap[e],target:this.diagramMap[l],anchors:["Bottom","Top"],fireEvent:false});k.setConnector(["Flowchart",{stub:[70,50],alwaysRespectStubs:true}]);k.setType("cartographic-generalization-"+p);var n=k.getOverlay("cartographic-square").getElement();app.plumb.makeSource(n,{anchor:["Right","Left"]});for(var r=1;r<w.length;r++){var v=app.plumb.connect({source:n,target:this.diagramMap[w[r].firstChild.nodeValue],fireEvent:false});v.endpoints[1].setAnchor("Top");v.setConnector(["Flowchart",{stub:[0,50],alwaysRespectStubs:true}]);v.setType("cartographic-leg")}break;case"generalization":var e=a.childNodes[0].firstChild.nodeValue;var A=a.childNodes[1].firstChild.nodeValue;var p=a.childNodes[2].firstChild.nodeValue;var w=a.childNodes[3].childNodes;var f="generalization-"+p+"-"+A;var t=function(c){if(c=="generalization-disjoint-partial"){return["Image",{src:"imgs/omtg/triangle-white.png",cssClass:"triangle-endpoint"}]}if(c=="generalization-overlapping-partial"){return["Image",{src:"imgs/omtg/triangle-black.png",cssClass:"triangle-endpoint"}]}if(c=="generalization-disjoint-total"){return["Image",{src:"imgs/omtg/triangle-circle-white.png",cssClass:"triangle-endpoint"}]}if(c=="generalization-overlapping-total"){return["Image",{src:"imgs/omtg/triangle-circle-black.png",cssClass:"triangle-endpoint"}]}};var h=function(c){if(c=="total"){return[0.5,1,0,1,0,20]}else{return[0.5,1,0,1,0,11]}};var j=app.plumb.addEndpoint(this.diagramMap[e],{anchor:h(A),connectionType:"generalization-leg",endpoint:t(f),isSource:true,isTarget:false,maxConnections:-1,uniqueEndpoint:true,parameters:{participation:A,disjointness:p}});for(var r=0;r<w.length;r++){var v=app.plumb.connect({source:j,anchors:["Bottom","Top"],target:this.diagramMap[w[r].firstChild.nodeValue],fireEvent:false});if(r==0){v.setType(f)}else{v.setType("generalization-leg")}v.setConnector(["Flowchart",{stub:[50,30],alwaysRespectStubs:true}])}break}},parseOMTGConnectionCardinality:function(e,b,d){if(d!="A"&&d!="B"){return}var c="",a="",f="";c=this.getValue(e.childNodes[0].firstChild);a=this.getValue(e.childNodes[1].firstChild);c=c>=0&&c!=""?c:"0";a=a>=1&&a!=""&&c<=a?a:"*";if(c==a){f=c}else{f=c+".."+a}b.getOverlay("cardinality-label"+d).setLabel(f);b.setParameter("min"+d,c);b.setParameter("max"+d,a)},getValue:function(a){if(a){return a.nodeValue}else{return""}}};